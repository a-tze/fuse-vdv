#include <inttypes.h>
#include <sys/types.h>
#include <assert.h>
#include "config.h"
#include "fuse-vdv-wav-demux.h"
#include "fuse-vdv-debug.h"
#include "fuse-vdv-filelist.h"

const char * wav_filepath = "/cut-demux.wav";
const int audio_bytes_per_frame = 1920 * 2 * 2;
off_t wav_filesize = 0;

#ifdef CONFIG_WITHWAVDEMUX

const unsigned int pcm_pal_16bit_channel0_offsets[] = {
	488, 28328, 56168, 12488, 40328, 68168, 24488, 52328, 8168, 
	36488, 64328, 20168, 48488, 4328, 32168, 60488, 16328, 44168, 
	1768, 29608, 57448, 13768, 41608, 69448, 25768, 53608, 9448, 
	37768, 65608, 21448, 49768, 5608, 33448, 61768, 17608, 45448, 
	3048, 30888, 58728, 15048, 42888, 70728, 27048, 54888, 10728, 
	39048, 66888, 22728, 51048, 6888, 34728, 63048, 18888, 46728, 
	490, 28330, 56170, 12490, 40330, 68170, 24490, 52330, 8170, 
	36490, 64330, 20170, 48490, 4330, 32170, 60490, 16330, 44170, 
	1770, 29610, 57450, 13770, 41610, 69450, 25770, 53610, 9450, 
	37770, 65610, 21450, 49770, 5610, 33450, 61770, 17610, 45450, 
	3050, 30890, 58730, 15050, 42890, 70730, 27050, 54890, 10730, 
	39050, 66890, 22730, 51050, 6890, 34730, 63050, 18890, 46730, 
	492, 28332, 56172, 12492, 40332, 68172, 24492, 52332, 8172, 
	36492, 64332, 20172, 48492, 4332, 32172, 60492, 16332, 44172, 
	1772, 29612, 57452, 13772, 41612, 69452, 25772, 53612, 9452, 
	37772, 65612, 21452, 49772, 5612, 33452, 61772, 17612, 45452, 
	3052, 30892, 58732, 15052, 42892, 70732, 27052, 54892, 10732, 
	39052, 66892, 22732, 51052, 6892, 34732, 63052, 18892, 46732, 
	494, 28334, 56174, 12494, 40334, 68174, 24494, 52334, 8174, 
	36494, 64334, 20174, 48494, 4334, 32174, 60494, 16334, 44174, 
	1774, 29614, 57454, 13774, 41614, 69454, 25774, 53614, 9454, 
	37774, 65614, 21454, 49774, 5614, 33454, 61774, 17614, 45454, 
	3054, 30894, 58734, 15054, 42894, 70734, 27054, 54894, 10734, 
	39054, 66894, 22734, 51054, 6894, 34734, 63054, 18894, 46734, 
	496, 28336, 56176, 12496, 40336, 68176, 24496, 52336, 8176, 
	36496, 64336, 20176, 48496, 4336, 32176, 60496, 16336, 44176, 
	1776, 29616, 57456, 13776, 41616, 69456, 25776, 53616, 9456, 
	37776, 65616, 21456, 49776, 5616, 33456, 61776, 17616, 45456, 
	3056, 30896, 58736, 15056, 42896, 70736, 27056, 54896, 10736, 
	39056, 66896, 22736, 51056, 6896, 34736, 63056, 18896, 46736, 
	498, 28338, 56178, 12498, 40338, 68178, 24498, 52338, 8178, 
	36498, 64338, 20178, 48498, 4338, 32178, 60498, 16338, 44178, 
	1778, 29618, 57458, 13778, 41618, 69458, 25778, 53618, 9458, 
	37778, 65618, 21458, 49778, 5618, 33458, 61778, 17618, 45458, 
	3058, 30898, 58738, 15058, 42898, 70738, 27058, 54898, 10738, 
	39058, 66898, 22738, 51058, 6898, 34738, 63058, 18898, 46738, 
	500, 28340, 56180, 12500, 40340, 68180, 24500, 52340, 8180, 
	36500, 64340, 20180, 48500, 4340, 32180, 60500, 16340, 44180, 
	1780, 29620, 57460, 13780, 41620, 69460, 25780, 53620, 9460, 
	37780, 65620, 21460, 49780, 5620, 33460, 61780, 17620, 45460, 
	3060, 30900, 58740, 15060, 42900, 70740, 27060, 54900, 10740, 
	39060, 66900, 22740, 51060, 6900, 34740, 63060, 18900, 46740, 
	502, 28342, 56182, 12502, 40342, 68182, 24502, 52342, 8182, 
	36502, 64342, 20182, 48502, 4342, 32182, 60502, 16342, 44182, 
	1782, 29622, 57462, 13782, 41622, 69462, 25782, 53622, 9462, 
	37782, 65622, 21462, 49782, 5622, 33462, 61782, 17622, 45462, 
	3062, 30902, 58742, 15062, 42902, 70742, 27062, 54902, 10742, 
	39062, 66902, 22742, 51062, 6902, 34742, 63062, 18902, 46742, 
	504, 28344, 56184, 12504, 40344, 68184, 24504, 52344, 8184, 
	36504, 64344, 20184, 48504, 4344, 32184, 60504, 16344, 44184, 
	1784, 29624, 57464, 13784, 41624, 69464, 25784, 53624, 9464, 
	37784, 65624, 21464, 49784, 5624, 33464, 61784, 17624, 45464, 
	3064, 30904, 58744, 15064, 42904, 70744, 27064, 54904, 10744, 
	39064, 66904, 22744, 51064, 6904, 34744, 63064, 18904, 46744, 
	506, 28346, 56186, 12506, 40346, 68186, 24506, 52346, 8186, 
	36506, 64346, 20186, 48506, 4346, 32186, 60506, 16346, 44186, 
	1786, 29626, 57466, 13786, 41626, 69466, 25786, 53626, 9466, 
	37786, 65626, 21466, 49786, 5626, 33466, 61786, 17626, 45466, 
	3066, 30906, 58746, 15066, 42906, 70746, 27066, 54906, 10746, 
	39066, 66906, 22746, 51066, 6906, 34746, 63066, 18906, 46746, 
	508, 28348, 56188, 12508, 40348, 68188, 24508, 52348, 8188, 
	36508, 64348, 20188, 48508, 4348, 32188, 60508, 16348, 44188, 
	1788, 29628, 57468, 13788, 41628, 69468, 25788, 53628, 9468, 
	37788, 65628, 21468, 49788, 5628, 33468, 61788, 17628, 45468, 
	3068, 30908, 58748, 15068, 42908, 70748, 27068, 54908, 10748, 
	39068, 66908, 22748, 51068, 6908, 34748, 63068, 18908, 46748, 
	510, 28350, 56190, 12510, 40350, 68190, 24510, 52350, 8190, 
	36510, 64350, 20190, 48510, 4350, 32190, 60510, 16350, 44190, 
	1790, 29630, 57470, 13790, 41630, 69470, 25790, 53630, 9470, 
	37790, 65630, 21470, 49790, 5630, 33470, 61790, 17630, 45470, 
	3070, 30910, 58750, 15070, 42910, 70750, 27070, 54910, 10750, 
	39070, 66910, 22750, 51070, 6910, 34750, 63070, 18910, 46750, 
	512, 28352, 56192, 12512, 40352, 68192, 24512, 52352, 8192, 
	36512, 64352, 20192, 48512, 4352, 32192, 60512, 16352, 44192, 
	1792, 29632, 57472, 13792, 41632, 69472, 25792, 53632, 9472, 
	37792, 65632, 21472, 49792, 5632, 33472, 61792, 17632, 45472, 
	3072, 30912, 58752, 15072, 42912, 70752, 27072, 54912, 10752, 
	39072, 66912, 22752, 51072, 6912, 34752, 63072, 18912, 46752, 
	514, 28354, 56194, 12514, 40354, 68194, 24514, 52354, 8194, 
	36514, 64354, 20194, 48514, 4354, 32194, 60514, 16354, 44194, 
	1794, 29634, 57474, 13794, 41634, 69474, 25794, 53634, 9474, 
	37794, 65634, 21474, 49794, 5634, 33474, 61794, 17634, 45474, 
	3074, 30914, 58754, 15074, 42914, 70754, 27074, 54914, 10754, 
	39074, 66914, 22754, 51074, 6914, 34754, 63074, 18914, 46754, 
	516, 28356, 56196, 12516, 40356, 68196, 24516, 52356, 8196, 
	36516, 64356, 20196, 48516, 4356, 32196, 60516, 16356, 44196, 
	1796, 29636, 57476, 13796, 41636, 69476, 25796, 53636, 9476, 
	37796, 65636, 21476, 49796, 5636, 33476, 61796, 17636, 45476, 
	3076, 30916, 58756, 15076, 42916, 70756, 27076, 54916, 10756, 
	39076, 66916, 22756, 51076, 6916, 34756, 63076, 18916, 46756, 
	518, 28358, 56198, 12518, 40358, 68198, 24518, 52358, 8198, 
	36518, 64358, 20198, 48518, 4358, 32198, 60518, 16358, 44198, 
	1798, 29638, 57478, 13798, 41638, 69478, 25798, 53638, 9478, 
	37798, 65638, 21478, 49798, 5638, 33478, 61798, 17638, 45478, 
	3078, 30918, 58758, 15078, 42918, 70758, 27078, 54918, 10758, 
	39078, 66918, 22758, 51078, 6918, 34758, 63078, 18918, 46758, 
	520, 28360, 56200, 12520, 40360, 68200, 24520, 52360, 8200, 
	36520, 64360, 20200, 48520, 4360, 32200, 60520, 16360, 44200, 
	1800, 29640, 57480, 13800, 41640, 69480, 25800, 53640, 9480, 
	37800, 65640, 21480, 49800, 5640, 33480, 61800, 17640, 45480, 
	3080, 30920, 58760, 15080, 42920, 70760, 27080, 54920, 10760, 
	39080, 66920, 22760, 51080, 6920, 34760, 63080, 18920, 46760, 
	522, 28362, 56202, 12522, 40362, 68202, 24522, 52362, 8202, 
	36522, 64362, 20202, 48522, 4362, 32202, 60522, 16362, 44202, 
	1802, 29642, 57482, 13802, 41642, 69482, 25802, 53642, 9482, 
	37802, 65642, 21482, 49802, 5642, 33482, 61802, 17642, 45482, 
	3082, 30922, 58762, 15082, 42922, 70762, 27082, 54922, 10762, 
	39082, 66922, 22762, 51082, 6922, 34762, 63082, 18922, 46762, 
	524, 28364, 56204, 12524, 40364, 68204, 24524, 52364, 8204, 
	36524, 64364, 20204, 48524, 4364, 32204, 60524, 16364, 44204, 
	1804, 29644, 57484, 13804, 41644, 69484, 25804, 53644, 9484, 
	37804, 65644, 21484, 49804, 5644, 33484, 61804, 17644, 45484, 
	3084, 30924, 58764, 15084, 42924, 70764, 27084, 54924, 10764, 
	39084, 66924, 22764, 51084, 6924, 34764, 63084, 18924, 46764, 
	526, 28366, 56206, 12526, 40366, 68206, 24526, 52366, 8206, 
	36526, 64366, 20206, 48526, 4366, 32206, 60526, 16366, 44206, 
	1806, 29646, 57486, 13806, 41646, 69486, 25806, 53646, 9486, 
	37806, 65646, 21486, 49806, 5646, 33486, 61806, 17646, 45486, 
	3086, 30926, 58766, 15086, 42926, 70766, 27086, 54926, 10766, 
	39086, 66926, 22766, 51086, 6926, 34766, 63086, 18926, 46766, 
	528, 28368, 56208, 12528, 40368, 68208, 24528, 52368, 8208, 
	36528, 64368, 20208, 48528, 4368, 32208, 60528, 16368, 44208, 
	1808, 29648, 57488, 13808, 41648, 69488, 25808, 53648, 9488, 
	37808, 65648, 21488, 49808, 5648, 33488, 61808, 17648, 45488, 
	3088, 30928, 58768, 15088, 42928, 70768, 27088, 54928, 10768, 
	39088, 66928, 22768, 51088, 6928, 34768, 63088, 18928, 46768, 
	530, 28370, 56210, 12530, 40370, 68210, 24530, 52370, 8210, 
	36530, 64370, 20210, 48530, 4370, 32210, 60530, 16370, 44210, 
	1810, 29650, 57490, 13810, 41650, 69490, 25810, 53650, 9490, 
	37810, 65650, 21490, 49810, 5650, 33490, 61810, 17650, 45490, 
	3090, 30930, 58770, 15090, 42930, 70770, 27090, 54930, 10770, 
	39090, 66930, 22770, 51090, 6930, 34770, 63090, 18930, 46770, 
	532, 28372, 56212, 12532, 40372, 68212, 24532, 52372, 8212, 
	36532, 64372, 20212, 48532, 4372, 32212, 60532, 16372, 44212, 
	1812, 29652, 57492, 13812, 41652, 69492, 25812, 53652, 9492, 
	37812, 65652, 21492, 49812, 5652, 33492, 61812, 17652, 45492, 
	3092, 30932, 58772, 15092, 42932, 70772, 27092, 54932, 10772, 
	39092, 66932, 22772, 51092, 6932, 34772, 63092, 18932, 46772, 
	534, 28374, 56214, 12534, 40374, 68214, 24534, 52374, 8214, 
	36534, 64374, 20214, 48534, 4374, 32214, 60534, 16374, 44214, 
	1814, 29654, 57494, 13814, 41654, 69494, 25814, 53654, 9494, 
	37814, 65654, 21494, 49814, 5654, 33494, 61814, 17654, 45494, 
	3094, 30934, 58774, 15094, 42934, 70774, 27094, 54934, 10774, 
	39094, 66934, 22774, 51094, 6934, 34774, 63094, 18934, 46774, 
	536, 28376, 56216, 12536, 40376, 68216, 24536, 52376, 8216, 
	36536, 64376, 20216, 48536, 4376, 32216, 60536, 16376, 44216, 
	1816, 29656, 57496, 13816, 41656, 69496, 25816, 53656, 9496, 
	37816, 65656, 21496, 49816, 5656, 33496, 61816, 17656, 45496, 
	3096, 30936, 58776, 15096, 42936, 70776, 27096, 54936, 10776, 
	39096, 66936, 22776, 51096, 6936, 34776, 63096, 18936, 46776, 
	538, 28378, 56218, 12538, 40378, 68218, 24538, 52378, 8218, 
	36538, 64378, 20218, 48538, 4378, 32218, 60538, 16378, 44218, 
	1818, 29658, 57498, 13818, 41658, 69498, 25818, 53658, 9498, 
	37818, 65658, 21498, 49818, 5658, 33498, 61818, 17658, 45498, 
	3098, 30938, 58778, 15098, 42938, 70778, 27098, 54938, 10778, 
	39098, 66938, 22778, 51098, 6938, 34778, 63098, 18938, 46778, 
	540, 28380, 56220, 12540, 40380, 68220, 24540, 52380, 8220, 
	36540, 64380, 20220, 48540, 4380, 32220, 60540, 16380, 44220, 
	1820, 29660, 57500, 13820, 41660, 69500, 25820, 53660, 9500, 
	37820, 65660, 21500, 49820, 5660, 33500, 61820, 17660, 45500, 
	3100, 30940, 58780, 15100, 42940, 70780, 27100, 54940, 10780, 
	39100, 66940, 22780, 51100, 6940, 34780, 63100, 18940, 46780, 
	542, 28382, 56222, 12542, 40382, 68222, 24542, 52382, 8222, 
	36542, 64382, 20222, 48542, 4382, 32222, 60542, 16382, 44222, 
	1822, 29662, 57502, 13822, 41662, 69502, 25822, 53662, 9502, 
	37822, 65662, 21502, 49822, 5662, 33502, 61822, 17662, 45502, 
	3102, 30942, 58782, 15102, 42942, 70782, 27102, 54942, 10782, 
	39102, 66942, 22782, 51102, 6942, 34782, 63102, 18942, 46782, 
	544, 28384, 56224, 12544, 40384, 68224, 24544, 52384, 8224, 
	36544, 64384, 20224, 48544, 4384, 32224, 60544, 16384, 44224, 
	1824, 29664, 57504, 13824, 41664, 69504, 25824, 53664, 9504, 
	37824, 65664, 21504, 49824, 5664, 33504, 61824, 17664, 45504, 
	3104, 30944, 58784, 15104, 42944, 70784, 27104, 54944, 10784, 
	39104, 66944, 22784, 51104, 6944, 34784, 63104, 18944, 46784, 
	546, 28386, 56226, 12546, 40386, 68226, 24546, 52386, 8226, 
	36546, 64386, 20226, 48546, 4386, 32226, 60546, 16386, 44226, 
	1826, 29666, 57506, 13826, 41666, 69506, 25826, 53666, 9506, 
	37826, 65666, 21506, 49826, 5666, 33506, 61826, 17666, 45506, 
	3106, 30946, 58786, 15106, 42946, 70786, 27106, 54946, 10786, 
	39106, 66946, 22786, 51106, 6946, 34786, 63106, 18946, 46786, 
	548, 28388, 56228, 12548, 40388, 68228, 24548, 52388, 8228, 
	36548, 64388, 20228, 48548, 4388, 32228, 60548, 16388, 44228, 
	1828, 29668, 57508, 13828, 41668, 69508, 25828, 53668, 9508, 
	37828, 65668, 21508, 49828, 5668, 33508, 61828, 17668, 45508, 
	3108, 30948, 58788, 15108, 42948, 70788, 27108, 54948, 10788, 
	39108, 66948, 22788, 51108, 6948, 34788, 63108, 18948, 46788, 
	550, 28390, 56230, 12550, 40390, 68230, 24550, 52390, 8230, 
	36550, 64390, 20230, 48550, 4390, 32230, 60550, 16390, 44230, 
	1830, 29670, 57510, 13830, 41670, 69510, 25830, 53670, 9510, 
	37830, 65670, 21510, 49830, 5670, 33510, 61830, 17670, 45510, 
	3110, 30950, 58790, 15110, 42950, 70790, 27110, 54950, 10790, 
	39110, 66950, 22790, 51110, 6950, 34790, 63110, 18950, 46790, 
	552, 28392, 56232, 12552, 40392, 68232, 24552, 52392, 8232, 
	36552, 64392, 20232, 48552, 4392, 32232, 60552, 16392, 44232, 
	1832, 29672, 57512, 13832, 41672, 69512, 25832, 53672, 9512, 
	37832, 65672, 21512, 49832, 5672, 33512, 61832, 17672, 45512, 
	3112, 30952, 58792, 15112, 42952, 70792, 27112, 54952, 10792, 
	39112, 66952, 22792, 51112, 6952, 34792, 63112, 18952, 46792, 
	554, 28394, 56234, 12554, 40394, 68234, 24554, 52394, 8234, 
	36554, 64394, 20234, 48554, 4394, 32234, 60554, 16394, 44234, 
	1834, 29674, 57514, 13834, 41674, 69514, 25834, 53674, 9514, 
	37834, 65674, 21514, 49834, 5674, 33514, 61834, 17674, 45514, 
	3114, 30954, 58794, 15114, 42954, 70794, 27114, 54954, 10794, 
	39114, 66954, 22794, 51114, 6954, 34794, 63114, 18954, 46794, 
	556, 28396, 56236, 12556, 40396, 68236, 24556, 52396, 8236, 
	36556, 64396, 20236, 48556, 4396, 32236, 60556, 16396, 44236, 
	1836, 29676, 57516, 13836, 41676, 69516, 25836, 53676, 9516, 
	37836, 65676, 21516, 49836, 5676, 33516, 61836, 17676, 45516, 
	3116, 30956, 58796, 15116, 42956, 70796, 27116, 54956, 10796, 
	39116, 66956, 22796, 51116, 6956, 34796, 63116, 18956, 46796, 
	558, 28398, 56238, 12558, 40398, 68238, 24558, 52398, 8238, 
	36558, 64398, 20238, 48558, 4398, 32238, 60558, 16398, 44238, 
	1838, 29678, 57518, 13838, 41678, 69518, 25838, 53678, 9518, 
	37838, 65678, 21518, 49838, 5678, 33518, 61838, 17678, 45518, 
	3118, 30958, 58798, 15118, 42958, 70798, 27118, 54958, 10798, 
	39118, 66958, 22798, 51118, 6958, 34798, 63118, 18958, 46798};

unsigned char pcm_16bit_header_template[] = {
	0x52, 0x49, 0x46, 0x46, 0xBA, 0xAD, 0xF0, 0x0D, 
	0x57, 0x41, 0x56, 0x45, 0x66, 0x6D, 0x74, 0x20, 
	0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x00, 
	0x80, 0xBB, 0x00, 0x00, 0x00, 0xEE, 0x02, 0x00, 
	0x04, 0x00, 0x10, 0x00, 0x64, 0x61, 0x74, 0x61, 
	0x00, 0xE0, 0x2E, 0x00};

void * pcm_16bit_header = NULL;

void copy_filesize_to_header() {
	uint32_t * head = (uint32_t*) pcm_16bit_header;
	// 2GiB-Limit!!!
	head[1] = (uint32_t) ((wav_filesize - 8) & 0x7FFFFFFF);
	head[10] = (uint32_t) ((wav_filesize - 44) & 0x7FFFFFFF);
}

void init_pcm_header() {
	if (pcm_16bit_header == NULL) {
		debug_printf("Allocating new header... ");
		pcm_16bit_header = malloc(sizeof(pcm_16bit_header_template));
		debug_printf("%p\n", pcm_16bit_header);
	}
	debug_printf ("Init PCM header for WAV demux: %p -> %p \n", pcm_16bit_header_template, pcm_16bit_header);
	memcpy(pcm_16bit_header, pcm_16bit_header_template, sizeof(pcm_16bit_header_template));
	copy_filesize_to_header();
}

void update_wav_filesize (off_t cut_filesize) {
	wav_filesize = ((cut_filesize / frame_size) * audio_bytes_per_frame) + 44;
}

static off_t get_dv_pos_from_wav_pos (off_t wavoffset) {
	if (wavoffset < 44) {
		return -1;
	}
	return ((wavoffset - 44) / audio_bytes_per_frame) * frame_size;
}

static int vdv_wav_header_read (char *buf, size_t size, off_t offset) {
	if (pcm_16bit_header == NULL) init_pcm_header();
	if (pcm_16bit_header == NULL) return 0;
	assert(offset + size <= 44);
	if (size == 0) {
		return 0;
	}
	uint32_t off = offset % 44;
	int i = 0;
	for (; i < size; i++) {
		buf[i] = ((char*)pcm_16bit_header)[off + i];
	}
	return size;
}

int vdv_wav_read (sourcefile_t * list, char *buf, size_t size, off_t offset, int depth) {

	debug_printf ("someone wants to read %d bytes of PCM at position %" PRId64 " (depth %d)\n", size, offset, depth);
	if ((list == NULL) || (offset < 0) || (size == 0) || (depth & 256)) {
		return 0;
	}
	if (depth == 0) {
		// no reading over the end of the virtual file...
		if (offset >= wav_filesize) {
			return 0;
		}
		if (offset + size > wav_filesize) {
			size = wav_filesize - offset;
		}
	}
	size_t readsize;
	// header is separate
	if (offset < 44) {
		readsize = 44 - offset;
		return vdv_wav_header_read (buf, readsize, offset) + vdv_wav_read (list, buf + readsize, size - readsize, offset + readsize, ++depth);
	}
	// get correct file
	off_t dvoffset = get_dv_pos_from_wav_pos(offset);
	assert(dvoffset % frame_size == 0);
	sourcefile_t * t = get_sourcefile_for_position (list, dvoffset);
	if (t == NULL) {
		return 0;
	}
	off_t start = dvoffset - t->globalpos + t->startpos;
	char* frbuf = (char*) malloc(frame_size);
	debug_printf (" reading dv frame at virt. position %" PRId64 " , reality is %d of file %s\n", dvoffset, start, t->filename);
	readsize = vdv_dv_do_read (t, frbuf, frame_size, start);
	if (readsize < frame_size) {
		// no complete frame, don't read anything
		free(frbuf);
		return 0;
	}
	// one video frame in frbuf, extract audio
	off_t rawoffset = offset - 44;
	uint32_t frstart = rawoffset % audio_bytes_per_frame;
	uint32_t i = 0;
	readsize = (size + frstart > audio_bytes_per_frame) ? (audio_bytes_per_frame - frstart) : size;
	// read loop
	while (i < readsize) { 
		switch (frstart % 4) {
		default:
		case '0':
			buf[i++] = frbuf[pcm_pal_16bit_channel0_offsets[frstart / 4] + 1];
			frstart++;
			if (i == readsize) break;
		case '1':
			buf[i++] = frbuf[pcm_pal_16bit_channel0_offsets[frstart / 4]];
			frstart++;
			if (i == readsize) break;
		case '2':
			buf[i++] = frbuf[72000 + pcm_pal_16bit_channel0_offsets[frstart / 4] + 1];
			frstart++;
			if (i == readsize) break;
		case '3':
			buf[i++] = frbuf[72000 + pcm_pal_16bit_channel0_offsets[frstart / 4]];
			frstart++;
			if (i == readsize) break;
		} 
	}
	free(frbuf);
	if (readsize >= size) {
		return i;
	} else {
		return i + vdv_wav_read (t, buf + readsize, size - readsize, offset + readsize, ++depth);
	}
}

#endif


